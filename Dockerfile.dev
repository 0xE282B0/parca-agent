FROM golang:1.18.1-bullseye as build

RUN echo "\
deb http://deb.debian.org/debian bullseye-backports main\n\
" >> /etc/apt/sources.list

RUN apt-get update -y && \
      apt-get install --no-install-recommends -y clang-11 llvm-11 make gcc coreutils elfutils binutils zlib1g-dev libelf-dev ca-certificates netbase && \
      ln -s /usr/bin/clang-11 /usr/bin/clang && \
      ln -s /usr/bin/llc-11 /usr/bin/llc

WORKDIR /parca-agent

COPY go.mod go.sum /parca-agent/
RUN go mod download -modcacherw

COPY parca-agent.bpf.c vmlinux.h Makefile ./
COPY ./3rdparty ./3rdparty
RUN make bpf

RUN go install github.com/go-delve/delve/cmd/dlv@v1.8.2

COPY . /parca-agent
RUN make build

FROM debian:bullseye-slim as all

RUN apt-get update -y && apt-get install --no-install-recommends -y elfutils binutils

COPY --from=build /etc/nsswitch.conf /etc/nsswitch.conf
COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt
COPY --from=build /usr/share/zoneinfo /usr/share/zoneinfo
COPY --from=build /parca-agent/dist/parca-agent /bin/parca-agent
COPY --from=build /go/bin/dlv /dlv

FROM scratch

COPY --chown=0:0 --from=all / /
RUN chown -R nobody:nogroup /tmp

EXPOSE 7071

ENTRYPOINT ["/dlv", "--listen=:40000", "--headless=true", "--api-version=2", "--accept-multiclient", "exec", "--continue", "--"]
